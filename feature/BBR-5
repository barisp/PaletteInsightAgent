--DROP TABLE threadinfo_p;

CREATE TABLE THREADINFO_P AS
 SELECT nextval('universal_id_seq'::regclass)AS PRIMARY_KEY,
    THREADINFO.*, (
        CPU_TIME - LAG (CPU_TIME) OVER (
            PARTITION BY HOST_NAME, PID,
            INSTANCE,
            TID
        ORDER BY HOST_NAME,
            PID,
            INSTANCE,
            TID,
            TS ASC
        )
    ) AS CPU_TIME_DELTA
FROM
    threadinfo;

--DROP TABLE HTTP_REQUESTS_WITH_WORKBOOKS;

CREATE TABLE HTTP_REQUESTS_WITH_WORKBOOKS AS
SELECT nextval('universal_id_seq'::regclass)AS PRIMARY_KEY,  T.* from (SELECT DISTINCT max(USER_IP), SITE_ID,    VIZQL_SESSION,
                SPLIT_PART( CURRENTSHEET, '/', 1 ) AS REPOSITORY_URL,
WORKBOOK_ID
                --SPLIT_PART( CURRENTSHEET, '/', 2 ) AS VIEW
         FROM   HTTP_REQUESTS
         LEFT OUTER JOIN (SELECT DISTINCT ID WORKBOOK_ID, REPOSITORY_URL FROM WORKBOOKS_PALETTE_HISTORY) H 
				ON (REPOSITORY_URL LIKE SPLIT_PART( CURRENTSHEET, '/', 1 ) )
         WHERE CURRENTSHEET IS NOT NULL AND VIZQL_SESSION IS NOT NULL AND VIZQL_SESSION <> '-'
		 ) T;
​
--DROP TABLE VIZQL_SESSION_THREAD;

CREATE TABLE VIZQL_SESSION_THREAD AS 
SELECT  nextval('universal_id_seq'::regclass)AS PRIMARY_KEY, FILENAME, HOST_NAME, MIN(TS) START_TS, MAX(TS) END_TS , MAX(TS)-MIN(TS) DURATION, PID, TID,  SESS VIZQL_SESSION, 
SITE, USERNAME FROM SERVERLOGS
WHERE FILENAME LIKE 'vizql%'
GROUP BY  FILENAME, HOST_NAME, PID, TID, SESS, 
SITE, USERNAME ;
​
​
--DROP TABLE INTERACTIVE_CPU_CONSUMPTION;

CREATE TABLE INTERACTIVE_CPU_CONSUMPTION AS 
SELECT nextval('universal_id_seq'::regclass)AS PRIMARY_KEY, TS, V.VIZQL_SESSION, W.REPOSITORY_URL, W.USER_IP, W.SITE_ID, CPU_TIME_DELTA CPU_TIME_CONSUMPTION,
INSTANCE, C.HOST_NAME, V.TID,V.PID, W.WORKBOOK_ID,  V.START_TS , V.END_TS, replace(USERNAME, 'local\\', '') AS USERNAME, date_trunc('hour',V.END_TS ) AS DAY_HOUR
FROM VIZQL_SESSION_THREAD V
LEFT OUTER JOIN THREADINFO_P C ON ( C.TS BETWEEN V.START_TS AND V.END_TS + INTERVAL '15 seconds' AND  C.PID = V.PID AND C.TID = V.TID)
LEFT OUTER JOIN HTTP_REQUESTS_WITH_WORKBOOKS W ON (W.VIZQL_SESSION = V.VIZQL_SESSION )
WHERE C.INSTANCE LIKE 'vizql%' 
AND WORKBOOK_ID IS NOT NULL;

-- INDEXES FOR INTERACTIVE_CPU_CONSUMPTION

CREATE INDEX IDX_INTERACTIVE_CPU_CONSUMPTION_VIZQL_SESSION ON INTERACTIVE_CPU_CONSUMPTION (VIZQL_SESSION);
CREATE UNIQUE INDEX IDX_INTERACTIVE_CPU_CONSUMPTION_PID_TID_TS ON INTERACTIVE_CPU_CONSUMPTION (TS, PID,TID, HOST_NAME, vizql_session);
CREATE INDEX IDX_INTERACTIVE_CPU_CONSUMPTION_WORKBOOK_ID ON INTERACTIVE_CPU_CONSUMPTION (WORKBOOK_ID);
CREATE INDEX IDX_INTERACTIVE_CPU_CONSUMPTION_USERNAME ON INTERACTIVE_CPU_CONSUMPTION (USERNAME);

-- DROP TABLE HTTP_REQUESTS_PALETTE_HISTORY;

CREATE TABLE HTTP_REQUESTS_PALETTE_HISTORY AS SELECT
	nextval('universal_id_seq'::regclass) AS PRIMARY_KEY,
	HTTP_REQUESTS.*,
	SITES_PALETTE_HISTORY. NAME AS SITE_NAME,
	USER_DETAILS.*, WORKBOOK_DETAILS.*
FROM
	HTTP_REQUESTS
LEFT OUTER JOIN (
	SELECT
		USERS_PALETTE_HISTORY.ID AS INTERACTOR_USER_ID,
		SYSTEM_USERS_PALETTE_HISTORY.ID AS INTERACTOR_SYSTEM_USERS_ID,
		SYSTEM_USERS_PALETTE_HISTORY.NAME AS INTERACTOR_USERNAME,
		SYSTEM_USERS_PALETTE_HISTORY.FRIENDLY_NAME AS INTERACTOR_FRIENDLY_NAME
	FROM
		USERS_PALETTE_HISTORY,
		SYSTEM_USERS_PALETTE_HISTORY
	WHERE
		--USERS_PALETTE_HISTORY.ID = 17299 AND 
		USERS_PALETTE_HISTORY.SYSTEM_USER_ID = SYSTEM_USERS_PALETTE_HISTORY.ID
) USER_DETAILS ON USER_DETAILS.INTERACTOR_USER_ID = HTTP_REQUESTS.USER_ID
LEFT OUTER JOIN SITES_PALETTE_HISTORY ON (
	SITES_PALETTE_HISTORY.ID = HTTP_REQUESTS.SITE_ID
)
LEFT OUTER JOIN (
	SELECT
		WORKBOOKS_PALETTE_HISTORY.ID AS WORKBOOK_ID,
		WORKBOOKS_PALETTE_HISTORY.NAME AS WORKBOOK_NAME,
		WORKBOOKS_PALETTE_HISTORY.REPOSITORY_URL AS WORKBOOK_REPOSITORY_URL,
		WORKBOOKS_PALETTE_HISTORY.OWNER_ID AS PUBLISHER_USER_ID,
		WORKBOOKS_PALETTE_HISTORY.PROJECT_ID,
		SYSTEM_USERS_PALETTE_HISTORY.ID AS PUBLISHER_SYSTEM_USERS_ID,
		SYSTEM_USERS_PALETTE_HISTORY.NAME AS PUBLISHER_USERNAME,
		SYSTEM_USERS_PALETTE_HISTORY.FRIENDLY_NAME AS PUBLISHER_FRIENDLY_NAME,
		PROJECTS_PALETTE_HISTORY.NAME AS PROJECT_NAME
	FROM
		WORKBOOKS_PALETTE_HISTORY,
		PROJECTS_PALETTE_HISTORY,
		USERS_PALETTE_HISTORY,
		SYSTEM_USERS_PALETTE_HISTORY
	WHERE
		WORKBOOKS_PALETTE_HISTORY.PROJECT_ID = PROJECTS_PALETTE_HISTORY.ID
	AND WORKBOOKS_PALETTE_HISTORY.OWNER_ID = USERS_PALETTE_HISTORY.ID
	AND USERS_PALETTE_HISTORY.SYSTEM_USER_ID = SYSTEM_USERS_PALETTE_HISTORY.ID
) WORKBOOK_DETAILS ON (
	WORKBOOK_REPOSITORY_URL LIKE SPLIT_PART(HTTP_REQUESTS.CURRENTSHEET,'/',1)
);
